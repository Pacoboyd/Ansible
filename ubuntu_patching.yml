---
- hosts: all
  tasks:
  - name: Update package cache
    apt:
      update_cache: yes
  - name: Autoremove unused packages
    apt:
      autoremove: yes
  - name: Update all packages to the latest version
    apt:
      upgrade: dist
  - name: Cleanup apt cache
    apt:
      autoclean: yes
  - name: Check if a reboot is required
    register: file
    stat: path=/var/run/reboot-required get_md5=no
  - name: Reboot the server
    command: shutdown -r +1 "Ansible initiated reboot for updates"
    when: file.stat.exists == true
    async: 1
    poll: 0
    ignore_errors: true
