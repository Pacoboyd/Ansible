---
- hosts: all
  tasks:
  - name: Update package cache
    apt: update_cache=yes
  - name: Autoremove unused packages
    command: apt-get -y autoremove
    register: autoremove_output
    changed_when: "'The following packages will be REMOVED' in autoremove_output.stdout"
  - name: Upgrade all packages to the latest version
    apt: upgrade=dist
  - name: Check if a reboot is required
    register: file
    stat: path=/var/run/reboot-required get_md5=no
  - name: Reboot the server
    command: shutdown -r now "Ansible reboot for updates"
    when: file.stat.exists == true
    async: 1
    poll: 0
    ignore_errors: true
  - name: Wait for server reboot to complete
    sudo: no
    local_action: wait_for host="{{ inventory_hostname }}" search_regex=OpenSSH port=22 timeout=300
